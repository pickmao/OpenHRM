# 干部动态调整系统 - 登录与鉴权系统使用说明

## 概述

本系统基于 Django REST Framework 和 JWT 实现了完整的登录鉴权体系，支持：

- 用户登录/登出
- JWT Token 管理（Access Token 15分钟，Refresh Token 7天）
- 基于角色的权限控制（RBAC）
- 数据范围控制（全部/组织单元/本人）
- 完整的审计日志

## API 接口

### 1. 用户登录

**接口地址**: `POST /api/auth/login/`

**请求参数**:
```json
{
  "username": "admin",
  "password": "admin123456",
  "captcha": "可选",
  "device_id": "可选"
}
```

**响应数据**:
```json
{
  "access": "jwt_access_token",
  "refresh": "jwt_refresh_token",
  "expires_in": 900,
  "user": {
    "id": "uuid",
    "username": "admin",
    "real_name": "系统管理员",
    "roles": ["SUPER_ADMIN"],
    "data_scope": {
      "scope_type": "ALL",
      "org_unit_ids": []
    },
    "permissions": ["cadres:view", "staffing:plan:apply", ...]
  }
}
```

### 2. 刷新Token

**接口地址**: `POST /api/auth/refresh/`

**请求参数**:
```json
{
  "refresh": "jwt_refresh_token"
}
```

**响应数据**:
```json
{
  "access": "new_jwt_access_token",
  "expires_in": 900
}
```

### 3. 用户登出

**接口地址**: `POST /api/auth/logout/`

**请求参数**:
```json
{
  "refresh": "jwt_refresh_token"
}
```

### 4. 获取当前用户信息

**接口地址**: `GET /api/auth/me/`

**响应数据**: 返回当前用户的基本信息、角色、数据范围和权限列表

### 5. 修改密码

**接口地址**: `POST /api/auth/change-password/`

**请求参数**:
```json
{
  "old_password": "旧密码",
  "new_password": "新密码",
  "confirm_password": "确认新密码"
}
```

## 权限体系

### 角色定义

| 角色代码 | 角色名称 | 说明 |
|---------|---------|------|
| SUPER_ADMIN | 系统超级管理员 | 拥有所有权限 |
| POLITICAL_OFFICE_ADMIN | 政治处管理员 | 全量干部管理 + 方案生效权限 |
| DEPT_MANAGER | 部门/支部负责人 | 仅本部门/支部 + 只能提草案 |
| ANALYST | 研判/统计人员 | 只读 + 报表权限 |
| CADRE_SELF | 本人账号 | 仅看个人档案 |

### 权限点列表

- `cadres:view` - 查看干部信息
- `cadres:create` - 创建干部信息
- `cadres:edit` - 编辑干部信息
- `cadres:delete` - 删除干部信息
- `orgs:view` - 查看组织信息
- `staffing:plan:create` - 创建调整方案
- `staffing:plan:submit` - 提交调整方案
- `staffing:plan:apply` - 生效调整方案
- `risk:view` - 查看风险信息
- `risk:manage` - 管理风险信息
- `audit:view` - 查看审计日志
- `analytics:view` - 查看分析报表

### 数据范围控制

- **ALL**: 可访问所有数据
- **ORG_UNIT**: 只能访问指定组织单元的数据
- **SELF**: 只能访问本人相关数据

## 系统初始化

### 1. 安装依赖

```bash
pip install djangorestframework
pip install djangorestframework-simplejwt
pip install django-cors-headers
```

### 2. 数据库迁移

```bash
python manage.py makemigrations
python manage.py migrate
```

### 3. 初始化系统数据

```bash
# 初始化角色和权限
python manage.py init_system

# 创建超级管理员
python manage.py init_system --create-superuser

# 创建演示用户
python manage.py init_system --create-demo-users
```

### 4. 默认账号

系统会创建以下演示账号：

| 用户名 | 密码 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin123456 | 超级管理员 | 拥有所有权限 |
| political_admin | 123456 | 政治处管理员 | 管理干部和方案 |
| dept_manager | 123456 | 部门负责人 | 管理本部门 |
| analyst | 123456 | 分析人员 | 只读权限 |

## 使用示例

### 1. 登录获取Token

```bash
curl -X POST http://localhost:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123456"
  }'
```

### 2. 使用Token访问API

```bash
curl -X GET http://localhost:8000/api/auth/me/ \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### 3. 刷新Token

```bash
curl -X POST http://localhost:8000/api/auth/refresh/ \
  -H "Content-Type: application/json" \
  -d '{"refresh": "YOUR_REFRESH_TOKEN"}'
```

## 注意事项

1. **安全性**: 生产环境请修改 `SECRET_KEY` 和默认密码
2. **HTTPS**: 生产环境必须使用 HTTPS
3. **CORS**: 根据需要配置 CORS 允许的域名
4. **审计日志**: 所有关键操作都会记录到 `AuditLog` 表
5. **Token 黑名单**: 登出后 refresh token 会被加入黑名单

## 扩展功能

系统预留了扩展接口，可以轻松集成：

- LDAP/AD 统一身份认证
- 短信验证码登录
- 单点登录（SSO）
- 多因素认证（MFA）

## 故障排查

### 常见问题

1. **登录失败**: 检查用户名密码是否正确，用户是否激活
2. **Token 无效**: 检查 Token 是否过期，或使用 refresh token 更新
3. **权限不足**: 检查用户角色和权限配置
4. **数据为空**: 检查用户的数据范围配置

### 日志查看

审计日志存储在 `audit_auditlog` 表中，包含：
- 操作人
- 操作类型
- 操作时间
- IP地址
- 详细上下文信息

## 技术架构

- **框架**: Django 4.2 + Django REST Framework
- **认证**: JWT (Simple JWT)
- **权限**: 基于角色的访问控制（RBAC）
- **数据隔离**: QuerySet 过滤器
- **审计**: 完整的操作日志记录